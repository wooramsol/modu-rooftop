<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>모두의옥상 v1.0</title>
  <link rel="manifest" href="manifest.json" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body, html {
      width: 100%; height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      background: #000; color: #fff; overflow: hidden;
    }
    #map { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; }
    header {
      position: absolute; top: 16px; left: 0; width: 100%;
      text-align: center; font-size: 20px; font-weight: 600;
      z-index: 2;
    }
    #modal {
      position: absolute; bottom: 0; left: 0; width: 100%;
      background: rgba(0,0,0,0.9); padding: 16px;
      display: none; flex-direction: column; gap: 12px;
      z-index: 3;
    }
    #modal input {
      padding: 12px; border: none; border-radius: 12px;
      font-size: 16px; background: #fff; color: #000;
    }
    #modal button {
      padding: 12px; border: none; border-radius: 12px;
      background: #fff; color: #000; font-weight: bold;
    }
  </style>
</head>
<body>
  <header>모두의옥상 v1.0</header>
  <div id="map"></div>
  <div id="modal">
    <input id="commentInput" placeholder="옥상 설명을 입력하세요" />
    <button id="saveBtn">저장</button>
    <button id="deleteBtn">삭제</button>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=a291afa9e1279e14eb5da1ad2a9f9c42&libraries=services,clusterer,drawing,geometry"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCq0HfajMY_GpKQ_KsdSNJmOy99PY97O2A",
      authDomain: "modulooptop.firebaseapp.com",
      databaseURL: "https://modulooptop-default-rtdb.firebaseio.com",
      projectId: "modulooptop",
      storageBucket: "modulooptop.appspot.com",
      messagingSenderId: "901771492678",
      appId: "1:901771492678:web:23b0cc4478cade894ab947"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database().ref("markers");

    const map = new kakao.maps.Map(document.getElementById("map"), {
      center: new kakao.maps.LatLng(37.5665, 126.9780),
      level: 4
    });

    let userPosition = null;
    let currentCoords = null;
    let circle = null;
    const markerObjs = {};

    const modal = document.getElementById("modal");
    const input = document.getElementById("commentInput");
    const saveBtn = document.getElementById("saveBtn");
    const deleteBtn = document.getElementById("deleteBtn");

    kakao.maps.event.addListener(map, "click", function(mouseEvent) {
      currentCoords = mouseEvent.latLng;
      input.value = "";
      deleteBtn.style.display = "none";
      modal.style.display = "flex";
    });

    saveBtn.onclick = () => {
      const comment = input.value.trim();
      if (!comment || !currentCoords) return;
      const newMarker = db.push();
      newMarker.set({
        lat: currentCoords.getLat(),
        lng: currentCoords.getLng(),
        comment: comment
      });
      modal.style.display = "none";
    };

    deleteBtn.onclick = () => {
      if (!currentCoords) return;
      Object.entries(markerObjs).forEach(([key, marker]) => {
        if (marker.getPosition().equals(currentCoords)) {
          db.child(key).remove();
          modal.style.display = "none";
        }
      });
    };

    function updateMarkerStyleFor(marker) {
      if (!marker) return;
      const pos = marker.getPosition();
      const distance = userPosition
        ? kakao.maps.geometry.spherical.computeDistance(userPosition, pos)
        : null;
      const imageSrc = distance !== null && distance <= 1000
        ? "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_black.png"
        : "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_grey.png";

      const markerImage = new kakao.maps.MarkerImage(
        imageSrc,
        new kakao.maps.Size(24, 35),
        { offset: new kakao.maps.Point(12, 35) }
      );
      marker.setImage(markerImage);
    }

    function updateMarkerStyles() {
      Object.values(markerObjs).forEach(updateMarkerStyleFor);
    }

    db.on('child_added', snap => {
      const v = snap.val();
      const key = snap.key;
      const marker = new kakao.maps.Marker({
        map,
        position: new kakao.maps.LatLng(v.lat, v.lng),
      });
      kakao.maps.event.addListener(marker, 'click', () => {
        currentCoords = marker.getPosition();
        input.value = v.comment || "";
        deleteBtn.style.display = "block";
        modal.style.display = "flex";
      });
      markerObjs[key] = marker;
      updateMarkerStyleFor(marker);
    });

    db.on('child_removed', snap => {
      const key = snap.key;
      if (markerObjs[key]) {
        markerObjs[key].setMap(null);
        delete markerObjs[key];
      }
    });

    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(pos => {
        userPosition = new kakao.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
        map.setCenter(userPosition);
        circle = new kakao.maps.Circle({
          center: userPosition,
          radius: 1000,
          strokeWeight: 2,
          strokeColor: '#fff',
          strokeOpacity: 0.8,
          fillColor: '#fff',
          fillOpacity: 0.1,
          zIndex: 10
        });
        circle.setMap(map);
        updateMarkerStyles();
      });
    }
  </script>
</body>
</html>
