<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <title>모두의 옥상</title>
  <style>
    html,
    body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: sans-serif;
      background: #000;
      color: #fff;
    }

    #map {
      width: 100%;
      height: 100%;
      filter: grayscale(1);
    }

    .overlay {
      position: absolute;
      background: #111;
      border: 1px solid #444;
      padding: 10px;
      z-index: 10;
      width: 200px;
    }

    .overlay textarea {
      width: 100%;
      background: #222;
      color: #fff;
      border: 1px solid #555;
      margin-top: 5px;
    }

    .overlay button {
      background: #333;
      color: #fff;
      border: none;
      padding: 5px;
      margin-top: 5px;
      cursor: pointer;
    }

    #title {
      position: absolute;
      top: 10px;
      left: 20px;
      font-size: 20px;
      font-weight: bold;
      color: white;
      z-index: 100;
      background: rgba(0, 0, 0, 0.5);
      padding: 6px 12px;
      border-radius: 8px;
    }
  </style>

  <!-- 카카오맵 -->
  <script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=a291afa9e1279e14eb5da1ad2a9f9c42"></script>

  <!-- Firebase SDKs (compat 버전 사용) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>

<body>
  <div id="map"></div>
  <div id="title">모두의옥상 v1.0</div>

  <script>
    // ✅ Firebase 설정
    const firebaseConfig = {
      apiKey: "AIzaSyCq0HfajMY_GpKQ_KsdSNJmOy99PY97O2A",
      authDomain: "modulooptop.firebaseapp.com",
      databaseURL: "https://modulooptop-default-rtdb.firebaseio.com",
      projectId: "modulooptop",
      storageBucket: "modulooptop.firebasestorage.app",
      messagingSenderId: "901771492678",
      appId: "1:901771492678:web:23b0cc4478cade894ab947",
      measurementId: "G-XYRMLJ98QC"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const ref = db.ref("markers");

    const map = new kakao.maps.Map(document.getElementById("map"), {
      center: new kakao.maps.LatLng(37.5665, 126.9780),
      level: 5
    });

    kakao.maps.event.addListener(map, "click", function (mouseEvent) {
      const latlng = mouseEvent.latLng;
      const projection = map.getProjection();
      const coord = projection.containerPointFromCoords(latlng);
      openForm(latlng, null, null, coord.x, coord.y);
    });

    function openForm(latlng, existing = null, key = null, x = 100, y = 100) {
      closeForm();
      const form = document.createElement("div");
      form.className = "overlay";

      const maxX = window.innerWidth - 220;
      const maxY = window.innerHeight - 220;
      const posX = Math.min(x, maxX);
      const posY = Math.min(y, maxY);

      form.style.left = posX + "px";
      form.style.top = posY + "px";

      form.innerHTML = `
        <textarea id="comment" rows="4" placeholder="옥상에 대한 설명을 입력해주세요">${existing ? existing.comment : ""}</textarea>
        <button onclick="saveMarker(${latlng.getLat()}, ${latlng.getLng()}, '${key || ''}')">저장</button>
        ${key ? `<button onclick="deleteMarker('${key}')">삭제</button>` : ""}
        <button onclick="closeForm()">닫기</button>
      `;
      document.body.appendChild(form);
    }

    function closeForm() {
      const old = document.querySelector(".overlay");
      if (old) old.remove();
    }

    function saveMarker(lat, lng, key = "") {
      const comment = document.getElementById("comment").value;
      if (!comment.trim()) return;
      const markerData = { lat, lng, comment };

      if (key) {
        ref.child(key).set(markerData);
      } else {
        ref.push(markerData);
      }

      closeForm();
    }

    function deleteMarker(key) {
      if (confirm("정말 삭제하시겠습니까?")) {
        ref.child(key).remove();
        closeForm();
      }
    }

    const markerObjects = {};

    function renderMarkers(data) {
      Object.values(markerObjects).forEach(m => m.setMap(null));
      Object.keys(markerObjects).forEach(k => delete markerObjects[k]);

      for (const [key, value] of Object.entries(data || {})) {
        const position = new kakao.maps.LatLng(value.lat, value.lng);
        const marker = new kakao.maps.Marker({ map, position });

        kakao.maps.event.addListener(marker, "click", () => {
          const coord = map.getProjection().containerPointFromCoords(position);
          openForm(position, value, key, coord.x, coord.y);
        });

        markerObjects[key] = marker;
      }
    }

    ref.on("value", (snapshot) => {
      renderMarkers(snapshot.val());
    });
  </script>
</body>

</html>